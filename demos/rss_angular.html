<!DOCTYPE html>
<html ng-app="RSS_Demo">
<head>
	<title>Media RSS using AngularJS - Example / Demo</title>

<link rel="stylesheet" href="../bootstrap/css/bootstrap.css" type="text/css">
<link rel="stylesheet" href="../bootstrap/css/bootstrap-responsive.css" type="text/css">
<link rel="stylesheet" href="../foundation_icons_general/stylesheets/general_foundicons.css" type="text/css">

<style>
body {padding: 0 30px;}
@media screen and (max-width: 640px) {
	body {padding: 0 10px;}
}

a {cursor: pointer;}

.well .rssThumb img {
	width: 132px;
	margin: 0 16px 4px 0;
}

.modal-body {max-height: 600px;}

#vPlayer {
	display: block;
	margin:0 auto 10px auto;
	width: 512px;
	height: 288px;
}

#vidTagAlert {
	text-align:center;
	display:none;
}

#aboutInfo .dropdown-menu {
	padding:10px;
	left:-100%;
}
#aboutInfo p.pull-right {
	text-align: right;
	margin-bottom: 0
}

.btnPadR {margin-right: 10px;}

.label {margin-right: 5px;}

.btn-group + .btn-group {margin-left: 0;}

#veil {
	position: absolute;
	top: 0;
	left: 0;
	height:100%;
	width:100%;
	cursor: not-allowed;
	filter: alpha(opacity=60);
	opacity: 0.6;
	background: #000000 url(AngularShieldLogo.png) no-repeat center;
}
#feedLoading {
	position: absolute;
	top:200px;
	width:100%;
	text-align: center;
	font-size: 4em;
	color:white;
	text-shadow: 2px 2px 2px #021124;
}
</style>

</head>
<body ng-controller="AppCtrl" ng-init="initApp()">

<div id="aboutInfo" class="pull-right">
	<div class="dropdown">
		<a id="dropInfo" role="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown">About this page</a>
		<div class="dropdown-menu small" aria-labelledby="dropInfo">

			<p>Media RSS demo using <a href="http://angularjs.org/" target="_blank">AngularJS</a>, <a href="https://developers.google.com/feed/" target="_blank">Google Feeds API</a>, <a href="http://jquery.com/" target="_blank">jQuery</a> and <a href="http://twitter.github.io/bootstrap/" target="_blank">Twitter bootstrap</a>.</p>

			<p class="pull-right" style=""><em>by <a href="http://www.wingo.com/services.html" title="wingo.com">Joseph Oster</a>, April 2013</em><br>
			<a href="http://www.wingo.com/services.html" title="wingo.com Web Site Design"><img src="../images/wsb.gif" width="111" height="40" alt="wingo.com Web Site Design" /></a></p>

		</div>
	</div>
</div>

<div ng-view></div>


<script type="text/ng-template" id="feed_view.html">
<a href="#/choose_feed" class="btn pull-right btnPadR">choose feed</a>

<h1 ng-cloak><a href="{{feed_result.link}}" target="_blank" ng-bind-html="feed_result.title"></a></h1>

<p ng-cloak>{{feed_result.description}}</p>

<div class="well well-small" ng-repeat="entry in feed_result.entries" list-done ng-cloak>
	<a ng-click="viewDetail(entry)" class="pull-left rssThumb" title="view detail" data-toggle="tooltip"><img ng-repeat="thumbnail in mediaOne(entry).thumbnails" src="{{thumbnail.url}}"></a>

	<a href="{{entry.link}}" target="_blank" title="view at {{feed_result.viewAt}}" data-toggle="tooltip"data-placement="left" class="btn btn-primary pull-right" style="margin: 0 0 5px 10px">View at...</a>

	<h4><a ng-click="viewDetail(entry)" title="view detail" data-toggle="tooltip">{{entry.title}}</a></h4>

	<p ng-bind-html="entry.contentSnippet"></p>

	<p class="muted">
		Posted: {{entry.publishedDate}} -
		<span class="label label-info" ng-repeat="category in entry.categories">{{category}}</span>
	</p>
</div>

<div class="modal hide fade" id="videoModal" ng-init="initModal()">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3 class="lead">{{currEntry.title}}</h3>
	</div>
	<div class="modal-body">

		<div id="vidTagAlert" class="alert alert-error">
			<button type="button" class="close" id="btnTagAlert">&times;</button>
			<strong>FAIL!</strong> The HTML5 &lt;video&gt; tag does not support .mp4 videos in Chrome and Firefox. Use Internet Explorer or Safari to watch these videos.
		</div>

		<video id="vPlayer" src="{{mediaOne(currEntry).url}}" controls autoplay ng-show="hasVideo(currEntry)"></video>

		<p ng-bind-html="currEntry.content"></p>

		<p class="muted">Posted: {{currEntry.publishedDate}} - <a href="{{currEntry.link}}" target="_blank" class="text-info" ng-click="endVideo()">view at {{feed_result.viewAt}}</a></p>
	</div>
</div>
</script>

<script type="text/ng-template" id="choose_feed.html">
<a href="#/" class="btn pull-right btnPadR">list view</a>

<h1>Choose RSS Feed</h1>

<div class="pull-left">

	<div class="input-prepend">
		<a ng-click="addFeed()" class="btn btn-primary add-on"><i class="foundicon-plus"></i> Add feed</a>
		<input type="text" class="span2" ng-model="newFeedUrl" placeholder="new feed url" style="width:80%;">
	</div>

	<div class="btn-group btn-block" ng-repeat="feed in feedList">
		<a ng-click="chooseFeed($index)" class="btn btn-inverse">{{feed | strip_http}}</a>
		<a ng-click="removeFeed($index)" class="btn btn-danger"><i class="foundicon-remove"></i></a>
	</div>

</div>
</script>


<div id="veil" ng-show="isLoading"></div>
<div id="feedLoading" ng-show="isLoading">Loading...</div>


<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="../bootstrap/js/bootstrap.js" type="text/javascript"></script>
<script src="https://www.google.com/jsapi"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.6/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.6/angular-sanitize.min.js"></script>

<script type="text/javascript">
console.log("start page");
google.load("feeds", "1");

angular.module('RSS_Demo', ['ngSanitize'])

	.config(function($locationProvider, $routeProvider) {
		//$locationProvider.html5Mode(true);
		$routeProvider
			.when('/', {
					templateUrl: "feed_view.html"
				})
			.when('/choose_feed', {
					templateUrl: "choose_feed.html",
					controller: "FeedCtrl"
				})		
	})

	.directive('listDone', function() {
		return function(scope, element, attrs) {
			if (scope.$last) { // all are rendered
				scope.layoutDone();
			}
		};
	})

	.service('rssFeed', function($q, $rootScope) {
		this.get = function(url) {
			var d = $q.defer();
			var feed = new google.feeds.Feed(url);
			feed.setNumEntries(1000);
			feed.load(function(result) {
				$rootScope.$apply(d.resolve(result));
			});
			return d.promise;
		}
	})

	.filter('strip_http', function() {
		return function(str) {
			var http = "http://";
			return (str.indexOf(http) == 0) ? str.substr(http.length) : str;
		}
	})

	.controller('AppCtrl', function($scope, $location, rssFeed) {

		$scope.setLoading = function(loading) {
			$scope.isLoading = loading;
		}

		$scope.loadFeed = function(url) {
			$scope.setLoading(true);
			rssFeed.get(url).then(function(result) {
				console.log(result);
				if (result.error) {
					alert("ERROR " + result.error.code + ": " + result.error.message + "\nurl: " + url);
					$scope.setLoading(false);
				}
				else {
					var urlParser = document.createElement('a');
					urlParser.href = result.feed.link;
					result.feed.viewAt = urlParser.hostname;
					$scope.feed_result = result.feed;
					$location.path('/');
					if ($scope.feed_result.entries == 0) {
						$scope.setLoading(false);
					}
				}
			});
		}

		$scope.layoutDone = function() {
			$scope.setLoading(false); // hide "Loading..."
			setTimeout(function() { // slight delay, init tooltips
				$('a[data-toggle="tooltip"]').tooltip();
			}, 500);
		}

		$scope.viewDetail = function(entry) {
			$scope.vidTagAlert.hide();
			$scope.videoPlay = $scope.hasVideo(entry); // show errors only after "Play" video
			$scope.currEntry = entry; // sets new url in <video> tag!
			$scope.videoModal.modal();
		}

		$scope.endVideo = function() {
			$scope.vPlayer.pause();
			$scope.currEntry = {};
		}

		$scope.mediaOne = function(entry) { // return first media object for 'entry'
			return (entry && entry.mediaGroups) ? entry.mediaGroups[0].contents[0] : {url:''};
		}

		$scope.hasVideo = function(entry) {
			return $scope.mediaOne(entry).type == "video/mp4";
		}

		$scope.initModal = function() {
			console.log('initModal');

			$scope.videoModal = $('#videoModal');
			$scope.videoModal.on('hidden', function() {
				$scope.endVideo()
			});

			$scope.vPlayer = $('#vPlayer')[0];
			$($scope.vPlayer).on('error', function() {
				if ($scope.videoPlay) {
					$scope.vidTagAlert.show();
				}
			});

			$scope.vidTagAlert = $('#vidTagAlert');
			$('#btnTagAlert').on('click', function() {
				$scope.vidTagAlert.hide();
			});

			$scope.$watch('currEntry', function() {
				if ($scope.hasVideo($scope.currEntry)) {
					$scope.vPlayer.load();
				}
			});
		}

		$scope.initApp = function() {
			console.log('initApp');
			$scope.feedList = [
				'http://feeds.feedburner.com/TEDTalks_video',
				'http://feeds.nationalgeographic.com/ng/photography/photo-of-the-day/',
				'http://sfbay.craigslist.org/eng/index.rss',
				'http://feeds.current.com/homepage/en_US.rss',
				'http://feeds.current.com/items/popular.rss',
				'http://www.nytimes.com/services/xml/rss/nyt/HomePage.xml',
				'http://www.wingo.com/index.rss'
			];

			$scope.loadFeed($scope.feedList[0]);
		}

	})

	.controller('FeedCtrl', function($scope) {

		$scope.addFeed = function() {
			$scope.feedList.unshift($scope.newFeedUrl);
			$scope.loadFeed($scope.feedList[0]);
		}

		$scope.removeFeed = function(idx) {
			$scope.feedList.splice(idx, 1);
		}

		$scope.chooseFeed = function(idx) {
			$scope.feedList.splice(0, 0, $scope.feedList.splice(idx, 1)[0]);
			$scope.loadFeed($scope.feedList[0]);
		}

	});
</script>

</body>
</html>